#!/bin/bash
# set  -x
printf "\n##########################"
printf "\n##  Start Custom Build  ##"
printf "\n##########################"


VERSION="$(grep 'ARG VERSION=' Dockerfile | awk -F'=' '{ print $2 }' | tr -d '"' )"
if [[ "$SOURCE_BRANCH" =~ ^[0-9.]+$ ]]; then
	printf "\n[RELEASE] Build for Repo: %s" 	"$DOCKER_REPO"
else
	if [[ "$SOURCE_BRANCH" == "master" ]]; then
		printf "\n[MASTER] Not Building from master"
		exit 0
	fi
	printf "\n[TEST] Build for Repo: %s" 	"$DOCKER_REPO"
fi
printf "\n-- SOURCE_BRANCH	: %s" 				"$SOURCE_BRANCH"
printf "\n-- SOURCE_COMMIT	: %s (%s)" 		"$SOURCE_COMMIT" 	"$COMMIT_MSG"
printf "\n-- REPO_NAME 			: %s" 				"$REPO_NAME"
printf "\n-- IMAGE_NAME 		: %s (%s)" 		"$IMAGE_NAME" 		"$CACHE_TAG"
printf "\n-- UMURMUR VERSION: %s" 				"$VERSION"
printf "\n--------------------------------\n"

buildUmurmur(){
	UMURMUR_VERSION="$1"
	SSL="$2"
	BUILD_NUMURMON="$3"
	BUILD_UMURMUR_MONITOR="$4"
	NAME="$5"

	if [ "$BUILD_NUMURMON" = "On" ] && [ "$BUILD_UMURMUR_MONITOR" = "On" ]; then
		tags="-t $NAME -t $NAME-full -t $(echo "$NAME" | awk -F':' '{ print $1 }'):latest"
		NAME="$NAME-full"
	else
		[ "$BUILD_NUMURMON" = "On" ] \
			&& NAME="$NAME-numurmon" && tags="-t $NAME"
		[ "$BUILD_UMURMUR_MONITOR" = "On" ] \
			&& NAME="$NAME-umonitor" && tags="-t $NAME"
		[ "$BUILD_NUMURMON" = "Off" ] && [ "$BUILD_UMURMUR_MONITOR" = "Off" ] \
			&& NAME="$NAME-light" && tags="-t $NAME"
	fi

	printf "\n\n## Building %s ##\n" "$NAME"
	if docker build $tags --build-arg VERSION="$UMURMUR_VERSION" --build-arg SSL="$SSL" --build-arg BUILD_NUMURMON="$BUILD_NUMURMON" --build-arg BUILD_UMURMUR_MONITOR="$BUILD_UMURMUR_MONITOR" . ; then
		echo "$NAME" >> hooks/names
	else
		printf "\nCannot build %s" "$NAME"
		exit 1
	fi
}

echo "" > hooks/names
for crypto in "openssl"; do
	for b_numurmon in "On" "Off"; do
		for b_umonitor in "On" "Off"; do
			buildUmurmur "$VERSION" $crypto $b_numurmon $b_umonitor "$REPO_NAME:$SOURCE_BRANCH-$VERSION"
		done
	done
done
