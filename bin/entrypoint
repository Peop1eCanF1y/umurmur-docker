#!/bin/sh

CFG_DIR="/etc/umurmur/"
START_CMD="$@"

# Copy all templates to /etc/umurmur/, evaluate them and delete the template files
processJ2Templates() {
	cp -R /templates/* "$CFG_DIR"
	for f in $(find "$CFG_DIR" -type f -name "*.j2"); do
	  echo -e "Evaluating template\n\tSource: $f\n\tDest: ${f%.j2}"
	  j2 $f > ${f%.j2}
	  rm -f $f
	done
}

# Run each shell script in /docker-entrypoint-init.d/
runInitScripts() {
	for f in /docker-entrypoint-init.d/*; do
	  case "$f" in
	      *.sh)  echo "Running $f"; . "$f" ;;
	      *)     echo "Ignoring $f" ;;
	  esac
	  echo
	done	
}

# Ensure permissions and ids are correct
updateIDs() {
	# Reset User UID if needed
	if [ $(id -u "${UMURMUR_USER}") -ne "${UMURMUR_UID}" ] && ! usermod -u "${UMURMUR_UID}" "${UMURMUR_USER}"; then
		printf "\nCannot change %s UID to %s" "${UMURMUR_USER}" "${UMURMUR_UID}"
		exit 1
	fi
	# Reset Group GUID if needed
	if [ $(id -g "${UMURMUR_USER}") -ne "${UMURMUR_GUID}" ] && ! groupmod -g "${UMURMUR_GUID}" "${UMURMUR_GROUP}"; then
		printf "\nCannot change %s GUID to %s" "${UMURMUR_GROUP}" "${UMURMUR_GUID}"
		exit 2
	fi
	# Reset permissions on CFG_DIR files
	find "$CFG_DIR" -maxdepth 1 -exec chown "${UMURMUR_USER}":"${UMURMUR_GROUP}" {} \;
	return 0
}

## INIT -------------------------------
processJ2Templates
runInitScripts
updateIDs

## EXECUTION --------------------------
cd "$CFG_DIR"
su -c "$START_CMD" "${UMURMUR_USER}"
